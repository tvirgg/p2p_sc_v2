# Проблемы в контракте P2P

В процессе тестирования контракта P2P были обнаружены следующие проблемы:

## 1. Неправильное хранение значения в unknown_funds

**Проблема:** Значение, хранящееся в словаре unknown_funds (48500000n), значительно отличается от ожидаемого значения (970000000n), рассчитанного на основе 3% комиссии от 1 TON.

**Детали:**
- Ожидаемое значение: 1 TON - 3% = 0.97 TON = 970000000n
- Фактическое значение: 0.0485 TON = 48500000n

**Возможные причины:**
- Дополнительные сборы или вычеты, которые не учитываются в тесте
- Ошибка в расчете комиссии
- Проблема с форматом хранения значения в контракте

## 2. Операция refund не отправляет средства обратно

**Проблема:** Операция refund удаляет запись unknown_fund из хранилища контракта, но не отправляет средства обратно отправителю.

**Детали:**
- После выполнения операции refund, баланс отправителя не изменяется
- Запись в unknown_funds успешно удаляется (становится 0n)
- Функция `send_transfer` вызывается, но средства не доходят до получателя

**Возможные причины:**
- Проблема в функции `send_transfer`
- Неправильные параметры при вызове `send_raw_message`
- Недостаточно газа для выполнения перевода

## 3. Отсутствие валидации в операции refund

**Проблема:** Контракт не проверяет, существует ли запись unknown_fund перед попыткой выполнить refund.

**Детали:**
- Повторный вызов refund с тем же ключом не вызывает ошибку, как ожидалось
- Контракт должен проверять наличие записи и выбрасывать исключение, если запись не найдена

**Возможные причины:**
- Отсутствие проверки на существование записи в словаре unknown_funds
- Неправильная обработка ошибок

## 4. Несоответствие между ожидаемой и фактической комиссией

**Проблема:** Фактическая комиссия, взимаемая с транзакции, может отличаться от ожидаемой.

**Детали:**
- В контракте указано, что комиссия составляет 3% для транзакций с memo
- Фактическая комиссия может быть выше из-за дополнительных сборов

## Рекомендации по исправлению

1. **Для проблемы с хранением значения:**
   - Проверить логику расчета комиссии в контракте
   - Убедиться, что нет дополнительных вычетов
   - Проверить формат хранения значения

2. **Для проблемы с операцией refund:**
   - Исправить функцию `send_transfer`, чтобы она корректно отправляла средства
   - Проверить параметры вызова `send_raw_message`
   - Убедиться, что достаточно газа для выполнения перевода

3. **Для проблемы с валидацией:**
   - Добавить проверку на существование записи в словаре unknown_funds
   - Выбрасывать исключение, если запись не найдена

4. **Для проблемы с комиссией:**
   - Уточнить и документировать все комиссии и сборы
   - Обновить тесты, чтобы они учитывали фактические комиссии

## Заключение

Эти проблемы могут привести к серьезным последствиям в реальной среде, особенно проблема с операцией refund, которая не отправляет средства обратно отправителю. Рекомендуется исправить эти проблемы перед использованием контракта в продакшене.
