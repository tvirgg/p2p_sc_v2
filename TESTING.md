# Тестирование смарт-контракта P2P Escrow

Этот документ содержит подробные инструкции по тестированию смарт-контракта P2P Escrow. Он охватывает как автоматическое тестирование с использованием Jest, так и процедуры ручного тестирования.

---

## Автоматическое тестирование

Проект включает автоматические тесты с использованием **Jest** и среды **TON Sandbox**, которая позволяет тестировать контракт без развёртывания в реальном блокчейне.

### Предварительные требования

- Node.js (версии 16 или выше)  
- npm или yarn

### Настройка

1. Клонируйте репозиторий  
2. Установите зависимости:

```bash
npm install
```

### Запуск тестов

Для запуска всех тестов:

```bash
npm test
```

Будет выполнен файл `tests/P2P.test.ts`.

### Структура тестов

Основной файл `tests/P2P.test.ts` содержит тесты, проверяющие следующие аспекты:

1. **Развёртывание контракта**  
2. **Создание сделки** между продавцом и покупателем  
3. **Финансирование сделки** покупателем  
4. **Проверка состояния сделки** после операций  

### Добавление новых тестов

Можно добавлять новые тесты, расширяя `P2P.test.ts` или создавая новые файлы в директории `tests`. Пример шаблона:

```typescript
it("should [описание теста]", async () => {
    // Подготовка

    // Действие

    // Проверка
    expect(...).toBe(...);
});
```

---

## Ручное тестирование

Можно также протестировать контракт вручную с помощью TON Blueprint.

### Локальное тестирование

#### 1. Сборка контракта

```bash
npm run build
```

#### 2. Создание скрипта тестирования

Пример:

```ts
// scripts/testP2P.ts
import { toNano, Address } from '@ton/core';
import { P2P } from '../wrappers/P2P';
import { compile, NetworkProvider } from '@ton/blueprint';

export async function run(provider: NetworkProvider) {
    const moderatorAddress = provider.sender().address!;
    const code = await compile('P2P');
    const p2p = provider.open(P2P.createFromConfig(moderatorAddress, code));

    await p2p.sendDeploy(provider.sender(), toNano('0.05'));
    await provider.waitForDeploy(p2p.address);
    console.log('Контракт развёрнут по адресу:', p2p.address.toString());

    const sellerAddress = Address.parse('EQD...'); // заменить
    const buyerAddress = Address.parse('EQD...'); // заменить
    const dealAmount = toNano('1');
    const memoText = "DEAL:TEST1";

    await p2p.sendCreateDeal(
        provider.sender(),
        moderatorAddress,
        sellerAddress,
        buyerAddress,
        dealAmount,
        memoText
    );
    console.log('Сделка создана с меткой:', memoText);

    const dealCounter = await p2p.getDealCounter();
    console.log('Счётчик сделок:', dealCounter);

    const dealInfo = await p2p.getDealInfo(0);
    console.log('Информация по сделке:', {
        amount: dealInfo.amount.toString(),
        funded: dealInfo.funded
    });
}
```

Запуск:

```bash
npm run bp run testP2P
```

---

### Тестирование в тестовой сети

1. Создайте `.env` файл с вашей мнемоникой:

```
MNEMONIC="ваша мнемоническая фраза"
```

2. Развёртывание в тестовой сети:

```bash
npm run bp deploy --network testnet
```

3. Скрипт взаимодействия с тестовой сетью:

```ts
// scripts/testnetP2P.ts
import { toNano, Address } from '@ton/core';
import { P2P } from '../wrappers/P2P';
import { NetworkProvider } from '@ton/blueprint';

export async function run(provider: NetworkProvider) {
    const p2p = provider.open(P2P.createFromAddress(
        Address.parse('EQD...') // Указать адрес развёрнутого контракта
    ));

    // Примеры операций...
}
```

---

## Тестовые сценарии

### 1. Базовый сценарий сделки

1. Модератор создаёт сделку  
2. Покупатель финансирует сделку  
3. Модератор завершает сделку в пользу продавца  
4. Проверить, что продавец получил средства

### 2. Возврат средств

1. Сделка создаётся  
2. Покупатель финансирует её  
3. Модератор возвращает средства покупателю  
4. Проверить, что возврат совершен

### 3. Обработка неизвестных переводов

1. Отправка средств без метки  
2. Проверка, что они сохранены как "неопознанные"  
3. Запрос возврата  
4. Проверка возврата отправителю

### 4. Вывод комиссий

1. Несколько завершённых сделок  
2. Вывод комиссий модератором  
3. Проверка поступления средств модератору

---

## Тестирование с различными параметрами

### Суммы сделок

- Маленькие: 0.1 TON  
- Средние: 10 TON  
- Большие: 100 TON  

### Метки

- Короткие: `"DEAL:1"`  
- Длинные описания  
- Символы и спецзнаки в строках

---

## Тестирование ошибок

1. **Дублирующая метка** — попытка создать две сделки с одинаковой меткой  
2. **Недостаточное финансирование** — отправка меньше требуемого  
3. **Неавторизованные действия** — попытка модераторских операций с обычного адреса  
4. **Несуществующая сделка** — попытка завершить несуществующую  
5. **Повторное финансирование** — сделка уже оплачена  
6. **Чрезмерный вывод комиссии** — попытка вывести больше, чем накоплено

---

## Тестирование газа

Замерьте использование газа при:

1. Развёртывании контракта  
2. Создании сделки  
3. Финансировании  
4. Завершении сделки  

Сравните и оптимизируйте, если необходимо.

---

## Интеграционные тесты

Если у вас есть frontend-приложение:

1. Развёрните контракт  
2. Подключите frontend к нему  
3. Выполните операции через интерфейс  
4. Проверьте состояние контракта

---

## Заключение

Следуя этим инструкциям, вы можете убедиться, что смарт-контракт P2P Escrow работает корректно и безопасно. Тестирование — ключевой этап, особенно перед развёртыванием в основной сети.

> ⚠️ Всегда тестируйте сначала в тестовой сети.

