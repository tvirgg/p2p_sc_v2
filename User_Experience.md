## Все пользовательские сценарии контракта (P2P-Escrow для TON)  

Ниже — полный перечень **реальных путей**, по которым участники взаимодействуют с контрактом. Каждый сценарий написан «как есть», с минимальной теорией и максимальной практикой: что делает пользователь, что отвечает контракт и какие грабли могут встретиться. Роли:  

| Роль | Кем является | Что может делать |
|------|--------------|------------------|
| **Seller** (продавец) | Получатель средств по сделке | Создавать сделку |
| **Buyer** (покупатель) | Отправитель средств | Финансировать сделку |
| **Moderator / Admin** | Доверенный арбитр (адрес хранится в контракте) | Решать спор, возвращать «потерянные» деньги, выводить комиссию |

Комиссия — **3 %** с любого входящего платежа. Минимальный остаток комиссии, который должен оставаться в контракте для газа — **0.5  TON** (`CP_RESERVE_GAS`).  

---

### 1. Создание сделки (Seller ➜ Contract)  

| Шаг | Действие | Условия / детали |
|-----|----------|------------------|
| 1 | Продавец формирует сообщение `op_create_deal` | Платёж ≥ `MIN_CREATE_FEE` (3 000 000 nanotons ≈ 0.003 TON). |
| 2 | Поля сообщения | `seller_addr`, `buyer_addr`, `amount`, `memo (cell)` + `query_id`. |
| 3 | Контракт удерживает `MIN_CREATE_FEE` как комиссию, записывает сделку в словарь `deals_dict`, увеличивает `deals_counter`, запоминает хеш `memo` → ID в `memo_map`. |
| 4 | Возврата нет. Успешный ответ — только изменение on-chain-состояния. |

*Грабли*: если прислать меньше, чем `MIN_CREATE_FEE`, контракт кинет ошибку 301.

---

### 2. Финансирование сделки (Buyer ➜ Contract)  

| Шаг | Действие | Условия |
|-----|----------|---------|
| 1 | Покупатель отправляет `op_fund_deal`, прикладывает **тот же `memo`** и кладёт нужную сумму (или больше). | Сделка найдена по хешу `memo`, статус «не профинансирована». |
| 2 | Контракт добавляет входящий платёж к «фонду сделки». | Если сумма ≥ `amount`, сделка помечается как **funded = 1**. |
| 3 | Случай переплаты | Излишек уходит в **Unknown Funds** (см. сценарий 6). |
| 4 | Комиссия 3 % от любого входящего платежа уходит в `commission_pool`. |

*Грабли*: если сделка уже funded = 1, ошибка 131.

---

### 3. Решение спора (Moderator ➜ Contract)  

| Шаг | Действие | Условия |
|-----|----------|---------|
| 1 | Модератор вызывает `op_resolve_deal`, передаёт `memo` и `verdict` (1 = деньги продавцу, 0 = возврат покупателю). | В контракте есть хотя бы `MIN_CP_FOR_ADMIN` (≈ 0.003 TON) на комиссии. |
| 2 | Если verdict = 1 → контракт перечисляет продавцу `amount − fee`, где fee = 3 % от суммы сделки, добавляя fee к `commission_pool`. | Сделка удаляется из словарей. |
| 3 | Если verdict = 0 → контракт возвращает покупателю **фактически внесённую** сумму (может быть < `amount`, если не хватило средств). | Сделка тоже удаляется. |

---

### 4. Возврат «потерянных» средств (Moderator ➜ Contract)  

Это деньги, которые попали в Unknown Funds (неправильный op-код, переплата, ошибочный перевод).  

| Шаг | Действие |
|-----|----------|
| 1 | Модератор вызывает `op_refund_unknown`, указывает `key` записи. |
| 2 | Контракт забирает запись из `unknown_funds`, возвращает деньги исходному отправителю, ключ кладёт в стек свободных (для повторного использования). |

*Лимит*: максимум **10 000** записей (`UF_MAX_RECORDS`).

---

### 5. Вывод комиссии (Moderator ➜ Contract)  

| Шаг | Действие | Условия |
|-----|----------|---------|
| 1 | Модератор вызывает `op_withdraw_commissions`. |
| 2 | Контракт проверяет, что после выплаты в пуле останется ≥ `CP_RESERVE_GAS` (0.5 TON). |
| 3 | Всё сверх резерва переводится модератору одним траншем. |

---

### 6. Неизвестное или пустое сообщение (Любой ➜ Contract)  

**Случай 1** — тело сообщения короче 32 бит (забыли op-код).  
**Случай 2** — op-код не распознан.  

| Что происходит | Как контракт реагирует |
|----------------|------------------------|
| Контракт берёт 3 % комиссии, остаток кладёт в `unknown_funds` под следующий свободный `key`. | Отправитель сможет получить возврат только через модератора (см. сценарий 4). |

---

### 7. Чтение данных (клиентские методы `get_*`)  

* **`get_deal_info(id)`** — узнать сумму сделки, флаг funded, сколько реально внесено.  
* **`get_deal_counter()`** — количество созданных сделок (последний использованный id).  
* **`get_commission_pool()`** — текущий объём комиссий.  
* **`get_unknown_fund(key)`** — сколько «зависло» по конкретному key.  

Эти методы бесплатные (off-chain), используются фронтом для отображения статуса.
