# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∫ —Å–º–∞—Ä—Ç‚Äë–∫–æ–Ω—Ç—Ä–∞–∫—Ç—É Escrow (v2.1)

> **–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è v2.1**  
> ‚Ä¢ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ –æ—à–∏–±–∫–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å **–±–æ–ª—å—à–µ, —á–µ–º –Ω—É–∂–Ω–æ**¬†‚Äî –∏–∑–ª–∏—à–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–æ–º –ø–∞–¥–∞—é—Ç –≤ `unknown_funds`.  
> ‚Ä¢ –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é –æ–Ω –ø–æ–ª—É—á–∞–µ—Ç **–ø–æ–ª–Ω—É—é —Å—É–º–º—É —Å–¥–µ–ª–∫–∏** (100‚ÄØ%).  
> ‚Ä¢ `op_withdraw_commissions` –≤—ã–≤–æ–¥–∏—Ç –≤—Å—ë, **–Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ—Ç 0.5‚ÄØTON** –≤ –ø—É–ª–µ –¥–ª—è –±—É–¥—É—â–µ–≥–æ –≥–∞–∑–∞.  
> ‚Ä¢ –î–ª—è ¬´–∑–∞–ª—ë—Ç–Ω—ã—Ö¬ª –ø–ª–∞—Ç–µ–∂–µ–π –±–µ–∑ `op`‚Äë–∫–æ–¥–∞ —Å–Ω–æ–≤–∞ —É–¥–µ—Ä–∂–∏–≤–∞–µ–º 3‚ÄØ% –∫–æ–º–∏—Å—Å–∏–∏.

---

## üõ† –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª (–∫–æ—Ä–æ—Ç–∫–æ)
1. **–°–æ–∑–¥–∞–Ω–∏–µ** —Å–¥–µ–ª–∫–∏ ‚Äî –ª—é–±–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ø–ª–∞—Ç–∏—Ç –∑–∞–ª–æ–≥ `MIN_CREATE_FEE` (0.03‚ÄØTON).  
2. **–§–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî –ø–æ–∫—É–ø–∞—Ç–µ–ª—å –ø–µ—Ä–µ–≤–æ–¥–∏—Ç **—Ä–æ–≤–Ω–æ `amt`** (–∏–ª–∏ –±–æ–ª—å—à–µ):  
   ‚Ä¢ 3‚ÄØ% –∫–æ–º–∏—Å—Å–∏–∏ —É—Ö–æ–¥–∏—Ç –≤ –ø—É–ª `cp`;  
   ‚Ä¢ –≤—Å—ë, —á—Ç–æ **—Å–≤–µ—Ä—Ö `amt`**, –ø–æ–ø–∞–¥–∞–µ—Ç –≤ `unknown_funds` –±–µ–∑ –∫–æ–º–∏—Å—Å–∏–∏.  
3. **–†–µ—à–µ–Ω–∏–µ** ‚Äî –º–æ–¥–µ—Ä–∞—Ç–æ—Ä:  
   ‚Ä¢ *verdict‚ÄØ=‚ÄØ1* ‚Üí –ø—Ä–æ–¥–∞–≤—Ü—É 97‚ÄØ% (`amt¬†‚Äì¬†3‚ÄØ%`);  
   ‚Ä¢ *verdict‚ÄØ=‚ÄØ0* ‚Üí –ø–æ–∫—É–ø–∞—Ç–µ–ª—é 100‚ÄØ% (`amt`).  
4. **–ö–æ–º–∏—Å—Å–∏–∏** ‚Äî –º–æ–¥–µ—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –≤—ã–≤–µ—Å—Ç–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è, –Ω–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç –≤—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–≤–∏—Ç 0.5‚ÄØTON –¥–ª—è –æ–ø–ª–∞—Ç—ã –±—É–¥—É—â–µ–≥–æ –≥–∞–∑–∞.

---

## 0 ‚îÇ –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
```func
const int COMMISSION_PERCENT  = 3;          ;; 3 %
const int MIN_CREATE_FEE      = 3_000_000;  ;; 0.03 TON
const int MIN_CP_FOR_ADMIN    = 3_000_000;  ;; 0.03 TON
const int CP_RESERVE_GAS      = 500_000_000;; 0.5  TON —Ä–µ–∑–µ—Ä–≤ –≤ –ø—É–ª–µ
```

---

## 1 ‚îÇ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ `recv_external`
```func
() recv_external(slice _) impure {
    throw(998);  ;; –≤–µ—Å—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
}
```

---

## 2 ‚îÇ Op‚Äë–∫–æ–¥—ã –∏ —Ä–æ–ª–∏
| op‚Äë–∫–æ–¥ | –≤—ã–∑—ã–≤–∞—é—â–∏–π | –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|--------|------------|------------|
| `op_create_deal`          | –ª—é–±–æ–π      | —Å–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É |
| `op_fund_deal`            | –ø–æ–∫—É–ø–∞—Ç–µ–ª—å | –ø—Ä–æ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞—Ç—å |
| `op_resolve_deal`         | –º–æ–¥–µ—Ä–∞—Ç–æ—Ä  | —Ä–µ—à–∏—Ç—å –∏—Å—Ö–æ–¥ |
| `op_refund_unknown`       | –º–æ–¥–µ—Ä–∞—Ç–æ—Ä  | –≤–µ—Ä–Ω—É—Ç—å –∑–∞–ª—ë—Ç–Ω—ã–µ |
| `op_withdraw_commissions` | –º–æ–¥–µ—Ä–∞—Ç–æ—Ä  | –≤—ã–≤–µ—Å—Ç–∏ –∫–æ–º–∏—Å—Å–∏–∏ |

---

## 3 ‚îÇ `op_create_deal`
*–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π* ‚Äî —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–ª–∞–¥—ë—Ç `MIN_CREATE_FEE` –≤ `cp`, —Å–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å—å —Å–¥–µ–ª–∫–∏.

---

## 4 ‚îÇ `op_fund_deal`
```func
if (op == op_fund_deal) {
    ;; –ü–æ–∫—É–ø–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–∏—Å–ª–∞—Ç—å ‚â• amt
    throw_if(132, msg_value < amt);

    int fee = (amt * COMMISSION_PERCENT) / 100; ;; 3 %
    cp += fee;                                   ;; –ø–æ–ø–æ–ª–Ω—è–µ–º –ø—É–ª

    ;; üí∞ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–ª–∏—à–∫–æ–≤
    int overpay = msg_value - amt;
    if (overpay > 0) {
        save_to_unknown_funds(sender, overpay);  ;; helper
    }

    mark_deal_funded(id, amt);                   ;; funded = 1, —Ö—Ä–∞–Ω–∏–º amt —Ü–µ–ª–∏–∫–æ–º
    save_data(...);
    return ();
}
```
*–ö–æ–º–∏—Å—Å–∏—è –±–µ—Ä—ë—Ç—Å—è **—Ç–æ–ª—å–∫–æ** —Å `amt`; ¬´–ø–µ—Ä–µ–ø–ª–∞—Ç–∞¬ª –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –≤ unknown_funds **–±–µ–∑** –≤—ã—á–µ—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏.*

---

## 5 ‚îÇ `op_resolve_deal`
```func
if (op == op_resolve_deal) {
    require_moderator(sender, ma);
    throw_if(401, cp < MIN_CP_FOR_ADMIN);

    if (verdict == 1) {
        int net = amt - (amt * COMMISSION_PERCENT) / 100;  ;; 97 %
        send_transfer(seller, net);
    } else {
        send_transfer(buyer, amt);                          ;; –ø–æ–ª–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç
    }

    cleanup(id);
    save_data(...);
}
```
*–ü–æ–∫—É–ø–∞—Ç–µ–ª—å –≤ —Å–ª—É—á–∞–µ –æ—Ç–º–µ–Ω—ã –ø–æ–ª—É—á–∞–µ—Ç –≤—Å—ë, –∫–æ–º–∏—Å—Å–∏—è –æ—Å—Ç–∞—ë—Ç—Å—è –≤ –ø—É–ª–µ.*

---

## 6 ‚îÇ `op_refund_unknown`  
–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ –ø–æ–º–Ω–∏–º: –≤ unknown_funds –ª–µ–∂–∏—Ç **–Ω–µ—Ç—Ç–æ** (100‚ÄØ% –µ—Å–ª–∏ –∏–∑–ª–∏—à–µ–∫, 97‚ÄØ% –µ—Å–ª–∏ –ø–ª–∞—Ç—ë–∂ –±–µ–∑ op‚Äë–∫–æ–¥–∞).

---

## 7 ‚îÇ `op_withdraw_commissions`
```func
if (op == op_withdraw_commissions) {
    require_moderator(sender, ma);
    throw_if(401, cp < MIN_CP_FOR_ADMIN);

    int payout = cp - CP_RESERVE_GAS;  ;; –æ—Å—Ç–∞–≤–ª—è–µ–º 0.5 TON
    if (payout > 0) {
        send_transfer(sender, payout);
        cp = CP_RESERVE_GAS;
    }
    save_data(...);
    return ();
}
```
*–ö–æ–Ω—Ç—Ä–∞–∫—Ç –≤—Å–µ–≥–¥–∞ –¥–µ—Ä–∂–∏—Ç ¬´–ø–æ–¥—É—à–∫—É¬ª 0.5‚ÄØTON –¥–ª—è –±—É–¥—É—â–∏—Ö –º–æ–¥‚Äë–æ–ø–µ—Ä–∞—Ü–∏–π.*

---

## 8 ‚îÇ –°—Ç—Ä–∞–π‚Äë–ø–ª–∞—Ç–µ–∂–∏ –±–µ–∑ `op`
–ü—Ä–∏ –≤—Ö–æ–¥—è—â–µ–º internal‚Äëtx –±–µ–∑ –æ–ø‚Äë–∫–æ–¥–∞:
1. –ü—Ä–æ–≤–µ—Ä—è–µ–º `value ‚â• 0.1‚ÄØTON`.  
2. –£–¥–µ—Ä–∂–∏–≤–∞–µ–º 3‚ÄØ% –∫–æ–º–∏—Å—Å–∏–∏ ‚Üí `cp`.  
3. –ù–µ—Ç—Ç–æ –∫–ª–∞–¥—ë–º –≤ `unknown_funds` –ø–æ–¥ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á.

---

## 9 ‚îÇ –§—Ä–æ–Ω—Ç–µ–Ω–¥‚Äë–ø–∞–º—è—Ç–∫–∞ (TL;DR)
| –≤—ã–∑–æ–≤                     | value                | —á—Ç–æ –≤–∞–∂–Ω–æ |
|---------------------------|----------------------|-----------|
| `op_create_deal`          | `0.03‚ÄØTON`           | –∑–∞–ª–æ–≥ —Å–ø–∞–º‚Äë—Ñ–∏–ª—å—Ç—Ä–∞ |
| `op_fund_deal`            | `amt¬†(+¬†–æ—à–∏–±–æ—á–Ω–∞—è –ø–µ—Ä–µ–ø–ª–∞—Ç–∞)` | UI –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å: ¬´–ï—Å–ª–∏ —Å–ª—É—á–∞–π–Ω–æ –ø–æ—à–ª—ë—Ç–µ –±–æ–ª—å—à–µ, –∏–∑–ª–∏—à–µ–∫ —É–π–¥—ë—Ç –≤ unknown_funds¬ª |
| `op_resolve_deal`         | `0`                  | verdict 1¬†‚Üí 97‚ÄØ% –ø—Ä–æ–¥–∞–≤—Ü—É, 0¬†‚Üí 100‚ÄØ% –ø–æ–∫—É–ø–∞—Ç–µ–ª—é |
| `op_refund_unknown`       | `0`                  | –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–∑ unknown_funds |
| `op_withdraw_commissions` | `0`                  | –≤—ã–≤–æ–¥–∏—Ç –≤—Å—ë >‚ÄØ0.5‚ÄØTON |

---

### üéØ –≠–∫–æ–Ω–æ–º–∏–∫–∞ –ø–æ—Å–ª–µ –ø–∞—Ç—á–∞
| –°—Ü–µ–Ω–∞—Ä–∏–π | –ü–æ–ª—É—á–∞—Ç–µ–ª—å | –ö–æ–º–∏—Å—Å–∏—è | cp –ø–æ—Å–ª–µ | unknown_funds |
|----------|-----------|----------|----------|---------------|
| –£—Å–ø–µ—à–Ω–∞—è —Å–¥–µ–ª–∫–∞ | –ø—Ä–æ–¥–∞–≤–µ—Ü 97‚ÄØ% | 3‚ÄØ% | +3‚ÄØ% | 0 |
| –û—Ç–º–µ–Ω–∞ | –ø–æ–∫—É–ø–∞—Ç–µ–ª—å 100‚ÄØ% | 3‚ÄØ% | +3‚ÄØ% | 0 |
| –ü–µ—Ä–µ–ø–ª–∞—Ç–∞ | n/a | 0 | 0 | +overpay |
| –°—Ç—Ä–∞–π‚Äë–ø–ª–∞—Ç—ë–∂ | n/a | 3‚ÄØ% | +3‚ÄØ% | +97‚ÄØ% |

–ö–æ–Ω—Ç—Ä–∞–∫—Ç –æ—Å—Ç–∞—ë—Ç—Å—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º, –ø—Ä–∏ —ç—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Ç–µ—Ä—è–µ—Ç –¥–µ–Ω—å–≥–∏ –∏–∑‚Äë–∑–∞ –æ–ø–µ—á–∞—Ç–æ–∫, –∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä –≤—Å–µ–≥–¥–∞ –∏–º–µ–µ—Ç —Ä–µ–∑–µ—Ä–≤ –Ω–∞ –≥–∞–∑.

